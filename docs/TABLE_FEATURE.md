# 表格功能使用说明

## 概述

表格功能允许在活动规则页面中展示结构化的数据，支持文字和图片混合，自动适配单元格高度，适用于活动时间表、奖励配置、阶段说明等场景。

## Excel 标记格式

### 基本结构

```
┌─────────────┬──────────┬──────────┬──────────┐
│ TABLE-      │          │          │          │  ← 表格开始标记
├─────────────┼──────────┼──────────┼──────────┤
│ (空或标记)   │  表头1    │  表头2    │  表头3    │  ← 表头行（加粗显示）
├─────────────┼──────────┼──────────┼──────────┤
│ (空或标记)   │  数据1-1  │  数据1-2  │  数据1-3  │  ← 数据行
├─────────────┼──────────┼──────────┼──────────┤
│ (空或标记)   │  数据2-1  │  数据2-2  │  数据2-3  │  ← 数据行
└─────────────┴──────────┴──────────┴──────────┘
```

### 标记说明

1. **TABLE-** 标记
   - 放置在第一列（标记列）
   - 表示表格开始
   - 下一行自动识别为表头

2. **表头行**
   - TABLE- 标记的下一行
   - 背景色：`rgba(255, 255, 255, 0.2)`
   - 文字：加粗、居中、白色

3. **数据行**
   - 表头之后的所有行
   - 背景色：`rgba(255, 255, 255, 0.1)`
   - 文字：左对齐（RTL语言右对齐）、垂直居中
   - 遇到以下情况停止：
     - 空行
     - 新的 `TABLE-` 标记
     - 其他标记（`TITLE-`, `RULES-`, `RINK-`）

### 图片支持

表格单元格中可以插入图片：

1. **图片识别**
   - 包含文件扩展名：`.png`, `.jpg`, `.jpeg`, `.gif`, `.webp`
   - 或以 `image:` 前缀开头

2. **图片渲染**
   - 自动充满单元格（保持比例）
   - 留有 8px 的 padding
   - 垂直居中显示

## 示例

### 示例 1：活动时间表

```
REGION-CN
┌─────────────┬──────────────┬──────────────┬──────────────┐
│ TABLE-      │              │              │              │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │   阶段名称     │   开始时间     │   结束时间     │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │   预热阶段     │   2024-01-01  │   2024-01-03  │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │   正式活动     │   2024-01-04  │   2024-01-10  │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │   兑奖期      │   2024-01-11  │   2024-01-15  │
└─────────────┴──────────────┴──────────────┴──────────────┘
```

### 示例 2：奖励配置（带图片）

```
REGION-EN
┌─────────────┬──────────────┬──────────────┬──────────────┐
│ TABLE-      │              │              │              │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │   Rank        │   Reward      │   Quantity    │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │   1st         │ diamond.png   │   1000        │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │   2nd-5th     │ gold.png      │   500         │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │   6th-10th    │ silver.png    │   200         │
└─────────────┴──────────────┴──────────────┴──────────────┘
```

## 样式规范

### 表头
- **背景色**：`rgba(255, 255, 255, 0.2)` (20% 白色)
- **文字**：加粗、居中、使用页面 `titleColor`（用户可自定义）
- **行高**：根据内容自动计算（最小 2 倍字体大小）

### 数据行
- **背景色**：`rgba(255, 255, 255, 0.1)` (10% 白色)
- **文字**：常规、左对齐（RTL 右对齐）、垂直居中、使用页面 `contentColor`（用户可自定义）
- **行高**：同一行所有单元格高度一致，取最高单元格的高度

### 边框
- **颜色**：`rgba(0, 0, 0, 0.3)` (30% 黑色)
- **宽度**：1px
- **位置**：所有单元格之间、表格外围
- **圆角**：四个角 8px 圆角

### 列宽
- **分配方式**：平均分配表格宽度
- **计算**：`列宽 = 表格总宽度 / 列数`

### 单元格 Padding
- **所有方向**：8px

## RTL 支持

表格完全支持 RTL（从右到左）语言：

- **阿拉伯语、希伯来语等**：文字自动右对齐
- **列顺序**：保持与源数据一致
- **文字方向**：由页面的 `direction` 属性控制（基于 region 代码）

## 技术实现

### 前端

1. **类型定义** (`types.ts`)
   ```typescript
   export type TableCell = {
     value: string;
     is_image: boolean;
     image?: ImageMeta;
   };
   
   export type TableData = {
     type: 'table';
     headers: string[];
     rows: TableCell[][];
   };
   ```

2. **表格组件** (`TableComponent.tsx`)
   - 使用 Konva 渲染表格
   - 自动测量每个单元格的实际渲染高度
   - 按行计算最大高度，确保同行单元格高度一致
   - 支持图片和文字混合

3. **页面组件** (`PageCanvas.tsx`)
   - 集成表格组件到页面布局
   - 自动计算表格高度并更新页面总高度

### 后端

1. **解析逻辑** (`excel_parser.py`)
   - `collect_table()` 函数识别 TABLE- 标记
   - 提取表头和数据行
   - 检测单元格中的图片标识
   - 记录图片位置信息（`_row`, `_col`, `_expected`）

2. **图片提取** (`image_extractor.py`)
   - 从 Excel 中提取嵌入的表格图片
   - 转换为 ImageMeta 格式
   - 存储到 blob 系统并返回 URL

## 注意事项

1. **合并单元格**
   - 后端会自动去重处理合并单元格
   - 同一内容在同一行只会出现一次

2. **列数不一致**
   - 表格列数以表头为准
   - 数据行列数不足时，后续列为空
   - 数据行列数超出时，超出部分被忽略

3. **空表格**
   - 如果 TABLE- 后没有数据，表格不会渲染

4. **表格高度**
   - 表格高度由实际内容决定
   - 文字自动换行适应列宽
   - 图片按比例缩放适应单元格

5. **性能考虑**
   - 大型表格（超过 20 行）可能影响渲染性能
   - 建议将大表格拆分为多个小表格

## 示例效果

渲染后的表格效果：

```
╔═══════════════════════════════════════╗
║  阶段名称  │  开始时间   │  结束时间   ║  ← 表头（加粗、居中、浅背景）
╠═══════════════════════════════════════╣
║  预热阶段  │  2024-01-01 │  2024-01-03 ║  ← 数据行（常规、左对齐、深背景）
║  正式活动  │  2024-01-04 │  2024-01-10 ║
║  兑奖期    │  2024-01-11 │  2024-01-15 ║
╚═══════════════════════════════════════╝
```

## 图片处理

### 后端识别

- Excel 中的嵌入图片自动识别并提取
- 空单元格位置如果有嵌入图片，会自动标记为图片单元格
- 图片元数据格式与奖励图片一致（ImageMeta）

### 前端渲染

- 图片在单元格内垂直和水平居中
- 保持图片原始比例
- 自动缩放以充满单元格（留有 padding）
- 图片加载逻辑与奖励图片一致

## 文本对齐

### 表头
- **水平**：居中
- **垂直**：根据实际文本高度居中
- **颜色**：使用页面设置的 `titleColor`（与页面标题颜色一致）

### 数据单元格
- **水平**：左对齐（RTL 语言右对齐）
- **垂直**：根据实际文本高度居中
- **换行**：自动换行适应列宽
- **颜色**：使用页面设置的 `contentColor`（与页面正文颜色一致）

## 更新日志

- **2024-11** - 初始版本
  - 支持基本表格渲染
  - 支持图片和文字混合
  - 自动高度测量
  - RTL 语言支持
  - 图片和文字垂直居中对齐
  - 空单元格自动检测嵌入图片
  - 文字颜色跟随页面设置（titleColor 和 contentColor）
  - 表格四角 8px 圆角设计

